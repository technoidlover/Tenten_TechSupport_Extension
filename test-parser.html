<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tenten HTML Parser</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        textarea { width: 100%; height: 200px; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a8c; }
    </style>
</head>
<body>
    <h1>Test Tenten HTML Parser</h1>
    
    <div class="test-section">
        <h3>Paste Tenten HTML Response:</h3>
        <textarea id="htmlInput" placeholder="Paste the HTML response from Tenten API here...">
<!-- Real HTML structure from nodesign.vn example -->
<style>
    .widthTD {
        width: 20%;
    }
</style>
<div class="info_whois_general">
    <div class="row">
        <div class="col-sm-8">
            <div class="ct_left">
            <div class="info_whois_title_box">
                <h2>Thông tin WHOIS tên miền <strong class="qb_red">nodesign.vn</strong></h2>
            </div>
            <div class="mobile_interface">
                <table>
                    <tbody>
                        <tr>
                        <td class="widthTD">Tên miền : </td>
                        <td><a href="https://nodesign.vn" target="_blank" class="link_whois">nodesign.vn</a></td>
                        </tr>
                        <tr>
                        <td>Ngày đăng ký : </td>
                        <td>16/01/2025</td>
                        </tr>
                        <tr>
                        <td>Ngày hết hạn : </td>
                        <td><strong>16/01/2026</strong></td>
                        </tr>
                        <tr>
                        <td>Chủ sở hữu tên miền : </td>
                        <td>CÔNG TY TNHH GIẢI PHÁP CÔNG NGHỆ HNG</td>
                        </tr>
                        <tr>
                        <td><span>Cờ trạng thái <a href="#" class="status_flags" aria-hidden="true" data-toggle="tooltip" data-html="true" data-placement="top" data-original-title="Cờ trạng thái tên miền là gì?"></a>:</span>
                        </td>
                        <td><ul>
                            <li>clientTransferProhibited</li>
                        </ul></td>
                        </tr>
                        <tr>
                        <td>Quản lý tại Nhà đăng ký : </td>
                        <td>Công ty Cổ phần GMO-Z.com RUNSYSTEM</td>
                        </tr>
                        <tr>
                        <td><span>Nameservers <a href="#" class="status_flags" aria-hidden="true" data-toggle="tooltip" data-html="true" data-placement="top" data-original-title="DNS là gì?"></a>:</span></td>
                        <td><ul>
                            <li>rayne.ns.cloudflare.com</li><li>zac.ns.cloudflare.com</li>
                        </ul></td>
                        </tr>
                        <tr>
                        <td><span>Registry Lock :</span></td>   
                        <td>Khoá bảo vệ an toàn 100% cho tên miền <a title="Tìm hiểu dịch vụ bảo vệ tên miền" target="_blank" href="https://tenten.vn/domain-lock"> | Tìm hiểu thêm </a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="ct_right">
            <div class="sb_register_whois">
                <span>Tên miền<strong> nodesign.vn </strong>đã được đăng ký</span>
                <a href="https://tenten.vn/DomainReservation?domain=nodesign.vn" target="_blank" class="ntbtm_btn">Nhận thông báo khi tên miền này tự do</a>
            </div>
            </div>
        </div>
    </div>
</div>
        </textarea>
        <br>
        <button onclick="testParser()">Test Parser</button>
        
        <div class="result">
            <h4>Parsed Result:</h4>
            <pre id="result"></pre>
        </div>
        
        <div class="result">
            <h4>Debug Info:</h4>
            <pre id="debug"></pre>
        </div>
    </div>

    <script>
        // Copy the parseTentenHTML function from background.js
        function parseTentenHTML(htmlData, domain) {
            console.log('Parsing Tenten HTML response...');
            console.log('HTML preview (first 500 chars):', htmlData.substring(0, 500));
            
            const result = {
                domainName: domain,
                creationDate: 'N/A',
                expirationDate: 'N/A',
                registrantName: 'N/A',
                status: 'N/A',
                registrarName: 'N/A',
                nameServers: 'N/A'
            };
            
            // Extract domain name from link or header
            const domainMatch = htmlData.match(/<a[^>]*href="https?:\/\/([^"]+)"[^>]*class="link_whois"[^>]*>([^<]+)<\/a>/i) ||
                               htmlData.match(/Thông tin WHOIS tên miền[^>]*<strong[^>]*>([^<]+)<\/strong>/i);
            if (domainMatch) {
                result.domainName = (domainMatch[2] || domainMatch[1]).trim();
                console.log('Domain name extracted:', result.domainName);
            }
            
            // Specific patterns based on the real HTML structure you provided
            // Pattern: <td class="widthTD">Ngày đăng ký : </td><td>16/01/2025</td>
            
            // Registration date
            const regDateMatch = htmlData.match(/<td[^>]*>Ngày đăng ký\s*:\s*<\/td>\s*<td[^>]*>([^<]+)<\/td>/i);
            if (regDateMatch && regDateMatch[1]) {
                result.creationDate = regDateMatch[1].trim();
                console.log('Registration date found:', result.creationDate);
            }
            
            // Expiration date - can be wrapped in <strong>
            const expDateMatch = htmlData.match(/<td[^>]*>Ngày hết hạn\s*:\s*<\/td>\s*<td[^>]*>(?:<strong[^>]*>)?([^<]+)(?:<\/strong>)?<\/td>/i);
            if (expDateMatch && expDateMatch[1]) {
                result.expirationDate = expDateMatch[1].trim();
                console.log('Expiration date found:', result.expirationDate);
            }
            
            // Registrant name
            const registrantMatch = htmlData.match(/<td[^>]*>Chủ sở hữu tên miền\s*:\s*<\/td>\s*<td[^>]*>([^<]+)<\/td>/i);
            if (registrantMatch && registrantMatch[1]) {
                result.registrantName = registrantMatch[1].trim();
                console.log('Registrant found:', result.registrantName);
            }
            
            // Registrar
            const registrarMatch = htmlData.match(/<td[^>]*>Quản lý tại Nhà đăng ký\s*:\s*<\/td>\s*<td[^>]*>([^<]+)<\/td>/i);
            if (registrarMatch && registrarMatch[1]) {
                result.registrarName = registrarMatch[1].trim();
                console.log('Registrar found:', result.registrarName);
            }
            
            // Status flags - extract from ul/li structure
            // Pattern: <td><span>Cờ trạng thái ...</span></td><td><ul><li>clientTransferProhibited</li></ul></td>
            const statusMatch = htmlData.match(/<td[^>]*><span[^>]*>Cờ trạng thái[^<]*<\/span>[^<]*<\/td>\s*<td[^>]*><ul>([\s\S]*?)<\/ul><\/td>/i);
            if (statusMatch && statusMatch[1]) {
                console.log('Status section found:', statusMatch[1]);
                const statusItems = statusMatch[1].match(/<li[^>]*>([^<]+)<\/li>/gi);
                if (statusItems && statusItems.length > 0) {
                    const statuses = statusItems.map(item => {
                        const match = item.match(/<li[^>]*>([^<]+)<\/li>/i);
                        return match ? match[1].trim() : '';
                    }).filter(status => status);
                    
                    if (statuses.length > 0) {
                        result.status = statuses.join(', ');
                        console.log('Status found:', result.status);
                    }
                }
            } else {
                // Fallback pattern for status - more flexible
                const altStatusMatch = htmlData.match(/Cờ trạng thái[^<]*<\/span>[^<]*<\/td>\s*<td[^>]*><ul>([\s\S]*?)<\/ul>/i);
                if (altStatusMatch && altStatusMatch[1]) {
                    console.log('Status (fallback) section found:', altStatusMatch[1]);
                    const statusItems = altStatusMatch[1].match(/<li[^>]*>([^<]+)<\/li>/gi);
                    if (statusItems && statusItems.length > 0) {
                        const statuses = statusItems.map(item => item.replace(/<[^>]*>/g, '').trim()).filter(status => status);
                        if (statuses.length > 0) {
                            result.status = statuses.join(', ');
                            console.log('Status (fallback) found:', result.status);
                        }
                    }
                }
            }
            
            // Nameservers - extract from ul/li structure  
            // Pattern: <td><span>Nameservers ...</span></td><td><ul><li>rayne.ns.cloudflare.com</li><li>zac.ns.cloudflare.com</li></ul></td>
            const nsMatch = htmlData.match(/<td[^>]*><span[^>]*>Nameservers[^<]*<\/span><\/td>\s*<td[^>]*><ul>([\s\S]*?)<\/ul><\/td>/i);
            if (nsMatch && nsMatch[1]) {
                console.log('Nameservers section found:', nsMatch[1]);
                const nsItems = nsMatch[1].match(/<li[^>]*>([^<]+)<\/li>/gi);
                if (nsItems && nsItems.length > 0) {
                    const nameServers = nsItems.map(item => {
                        const match = item.match(/<li[^>]*>([^<]+)<\/li>/i);
                        return match ? match[1].trim() : '';
                    }).filter(ns => ns);
                    
                    if (nameServers.length > 0) {
                        result.nameServers = nameServers.join(', ');
                        console.log('Nameservers found:', result.nameServers);
                    }
                }
            } else {
                // Fallback pattern for nameservers - more flexible
                const altNsMatch = htmlData.match(/Nameservers[^<]*<\/span><\/td>\s*<td[^>]*><ul>([\s\S]*?)<\/ul>/i);
                if (altNsMatch && altNsMatch[1]) {
                    console.log('Nameservers (fallback) section found:', altNsMatch[1]);
                    const nsItems = altNsMatch[1].match(/<li[^>]*>([^<]+)<\/li>/gi);
                    if (nsItems && nsItems.length > 0) {
                        const nameServers = nsItems.map(item => item.replace(/<[^>]*>/g, '').trim()).filter(ns => ns);
                        if (nameServers.length > 0) {
                            result.nameServers = nameServers.join(', ');
                            console.log('Nameservers (fallback) found:', result.nameServers);
                        }
                    }
                }
            }
            
            // Fallback patterns if the above don't work
            if (result.creationDate === 'N/A') {
                // Try simpler pattern
                const altRegDate = htmlData.match(/Ngày đăng ký[:\s]*([^\n\r<]+)/i);
                if (altRegDate && altRegDate[1]) {
                    result.creationDate = altRegDate[1].trim();
                    console.log('Registration date (fallback):', result.creationDate);
                }
            }
            
            if (result.expirationDate === 'N/A') {
                // Try simpler pattern
                const altExpDate = htmlData.match(/Ngày hết hạn[:\s]*([^\n\r<]+)/i);
                if (altExpDate && altExpDate[1]) {
                    result.expirationDate = altExpDate[1].trim();
                    console.log('Expiration date (fallback):', result.expirationDate);
                }
            }
            
            console.log('Final parsed result:', result);
            return result;
        }

        function testParser() {
            const htmlInput = document.getElementById('htmlInput').value;
            const debugDiv = document.getElementById('debug');
            const resultDiv = document.getElementById('result');
            
            // Clear previous results
            debugDiv.textContent = '';
            resultDiv.textContent = '';
            
            // Capture console.log output
            const debugOutput = [];
            const originalLog = console.log;
            console.log = function(...args) {
                debugOutput.push(args.join(' '));
                originalLog.apply(console, args);
            };
            
            try {
                const result = parseTentenHTML(htmlInput, 'test-domain.vn');
                
                // Display result
                resultDiv.textContent = JSON.stringify(result, null, 2);
                
                // Display debug info
                debugDiv.textContent = debugOutput.join('\n');
                
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                debugDiv.textContent = debugOutput.join('\n') + '\nError: ' + error.stack;
            }
            
            // Restore console.log
            console.log = originalLog;
        }

        // Test with sample data on load
        window.onload = function() {
            testParser();
        };
    </script>
</body>
</html>
