<!DOCTYPE html>
<html>
<head>
    <title>Test IP Info API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .debug { background: #e8f4fd; padding: 10px; margin: 5px 0; font-size: 12px; }
        input { padding: 8px; margin: 5px; width: 200px; }
        button { padding: 8px 15px; background: #007cba; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test IP Info API</h1>
    
    <div>
        <input type="text" id="hostInput" placeholder="Enter IP or domain" value="skylinelogistics.com.vn">
        <button onclick="testIpInfo()">Test IP Info</button>
    </div>
    
    <div class="result">
        <h3>Result:</h3>
        <div id="result"></div>
    </div>
    
    <div class="debug">
        <h4>Debug Info:</h4>
        <div id="debug"></div>
    </div>

    <script>
        async function testIpInfo() {
            const host = document.getElementById('hostInput').value.trim();
            const resultDiv = document.getElementById('result');
            const debugDiv = document.getElementById('debug');
            
            if (!host) {
                alert('Please enter a host');
                return;
            }
            
            resultDiv.innerHTML = 'Loading...';
            debugDiv.innerHTML = '';
            
            try {
                // Step 1: Get CSRF token
                console.log('Step 1: Getting CSRF token...');
                const homepageResponse = await fetch('https://check-host.net/ip-info', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!homepageResponse.ok) {
                    throw new Error(`Homepage request failed: ${homepageResponse.status}`);
                }
                
                const htmlText = await homepageResponse.text();
                console.log('Homepage HTML length:', htmlText.length);
                
                // Extract CSRF token
                let csrfToken = '';
                const csrfMatch = htmlText.match(/name="csrf_token"\\s+value="([^"]+)"/i);
                if (csrfMatch && csrfMatch[1]) {
                    csrfToken = csrfMatch[1];
                    console.log('Found CSRF token:', csrfToken.substring(0, 20) + '...');
                } else {
                    throw new Error('Could not find CSRF token');
                }
                
                debugDiv.innerHTML += `CSRF Token: ${csrfToken.substring(0, 20)}...<br>`;
                
                // Step 2: Make IP info request
                console.log('Step 2: Making IP info request...');
                const ipInfoUrl = `https://check-host.net/ip-info?host=${encodeURIComponent(host)}&csrf_token=${encodeURIComponent(csrfToken)}`;
                console.log('IP Info URL:', ipInfoUrl);
                
                const ipInfoResponse = await fetch(ipInfoUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Referer': 'https://check-host.net/ip-info'
                    }
                });
                
                console.log('IP Info response status:', ipInfoResponse.status);
                debugDiv.innerHTML += `Response Status: ${ipInfoResponse.status}<br>`;
                
                if (ipInfoResponse.ok) {
                    const responseText = await ipInfoResponse.text();
                    console.log('Response length:', responseText.length);
                    debugDiv.innerHTML += `Response Length: ${responseText.length}<br>`;
                    
                    // Show first 1000 chars of response for debugging
                    debugDiv.innerHTML += `<br>Response Preview:<br><pre>${responseText.substring(0, 1000)}...</pre>`;
                    
                    // Try to parse
                    const parsedData = parseCheckHostHTML(responseText, host);
                    resultDiv.innerHTML = `<pre>${JSON.stringify(parsedData, null, 2)}</pre>`;
                    
                } else {
                    throw new Error(`API returned status ${ipInfoResponse.status}: ${ipInfoResponse.statusText}`);
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `Error: ${error.message}`;
                debugDiv.innerHTML += `<br>Error: ${error.message}`;
            }
        }
        
        function parseCheckHostHTML(htmlData, host) {
            console.log('Parsing Check-Host HTML response...');
            
            const result = {
                host: host,
                ipAddress: 'N/A',
                hostname: 'N/A',
                ipRange: 'N/A',
                isp: 'N/A',
                organization: 'N/A',
                country: 'N/A',
                region: 'N/A',
                city: 'N/A',
                timezone: 'N/A',
                localTime: 'N/A',
                postalCode: 'N/A'
            };
            
            // Extract multiple IP info sections
            const ipInfoSections = htmlData.match(/<div class="ipinfo-item[^>]*"[^>]*>[\s\S]*?<\/div>\s*<script/gi) || [];
            console.log(`Found ${ipInfoSections.length} IP info sections`);
            
            // For debugging, let's try simpler pattern
            const tableRows = htmlData.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];
            console.log(`Found ${tableRows.length} table rows`);
            
            for (const row of tableRows) {
                const cells = row.match(/<td[^>]*>([\s\S]*?)<\/td>/gi);
                if (!cells || cells.length < 2) continue;
                
                const label = cells[0].replace(/<[^>]*>/g, '').trim().toLowerCase();
                const value = cells[1].replace(/<[^>]*>/g, '').trim();
                
                if (!value || value === '') continue;
                
                console.log(`Found: ${label} -> ${value}`);
                
                // Map labels to data fields
                if (label.includes('ip address')) {
                    result.ipAddress = value;
                } else if (label.includes('host name') || label.includes('hostname')) {
                    result.hostname = value;
                } else if (label.includes('ip range')) {
                    result.ipRange = value.split(' ')[0];
                } else if (label.includes('isp')) {
                    result.isp = value;
                } else if (label.includes('organization')) {
                    result.organization = value;
                } else if (label.includes('country')) {
                    result.country = value;
                } else if (label.includes('region')) {
                    result.region = value;
                } else if (label.includes('city')) {
                    result.city = value;
                } else if (label.includes('time zone')) {
                    result.timezone = value;
                } else if (label.includes('local time')) {
                    result.localTime = value;
                } else if (label.includes('postal code')) {
                    result.postalCode = value;
                }
            }
            
            console.log('Parsed result:', result);
            return result;
        }
    </script>
</body>
</html>
